name: Deploy Statsland Website Frontend

on:
  push:
    branches:
      - "release/**"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment:
      name: dev
      url: https://dev.statslandfantasy.com

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Deploy Infrastructure
        run: |
          sam deploy \
            --template-file template.yaml \
            --stack-name statsland-website-dev \
            --capabilities CAPABILITY_IAM \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Environment=dev \
              DomainName=${{ secrets.DOMAIN_NAME }} \
              CertificateArn=${{ secrets.CERTIFICATE_ARN }}

      - name: Get Stack Outputs
        id: stack-outputs
        run: |
          BUCKET=$(aws cloudformation describe-stacks \
            --stack-name statsland-website-dev \
            --query 'Stacks[0].Outputs[?OutputKey==`BucketName`].OutputValue' \
            --output text)

          DIST_ID=$(aws cloudformation describe-stacks \
            --stack-name statsland-website-dev \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
            --output text)

          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "distribution=$DIST_ID" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Build React App
        env:
          REACT_APP_API_URL: ${{ secrets.API_URL }}
          REACT_APP_AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          REACT_APP_AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
          REACT_APP_AUTH0_AUDIENCE: ${{ secrets.AUTH0_AUDIENCE }}
          REACT_APP_ENVIRONMENT: dev
        run: |
          npm ci
          npm run build

      - name: Deploy to S3
        run: |
          aws s3 sync build/ s3://${{ steps.stack-outputs.outputs.bucket }}/ \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "index.html" \
            --exclude "asset-manifest.json"

          aws s3 cp build/index.html s3://${{ steps.stack-outputs.outputs.bucket }}/index.html \
            --cache-control "public,max-age=0,must-revalidate"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.stack-outputs.outputs.distribution }} \
            --paths "/*"

  deploy-prod:
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: https://statslandfantasy.com

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Deploy Infrastructure
        run: |
          sam deploy \
            --template-file template.yaml \
            --stack-name statsland-website-prod \
            --capabilities CAPABILITY_IAM \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Environment=prod \
              DomainName=${{ secrets.DOMAIN_NAME }} \
              CertificateArn=${{ secrets.CERTIFICATE_ARN }}

      - name: Get Stack Outputs
        id: stack-outputs
        run: |
          BUCKET=$(aws cloudformation describe-stacks \
            --stack-name statsland-website-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`BucketName`].OutputValue' \
            --output text)

          DIST_ID=$(aws cloudformation describe-stacks \
            --stack-name statsland-website-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
            --output text)

          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "distribution=$DIST_ID" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Build React App
        env:
          REACT_APP_API_URL: ${{ secrets.API_URL }}
          REACT_APP_AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          REACT_APP_AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
          REACT_APP_AUTH0_AUDIENCE: ${{ secrets.AUTH0_AUDIENCE }}
          REACT_APP_ENVIRONMENT: prod
        run: |
          npm ci
          npm run build

      - name: Deploy to S3
        run: |
          aws s3 sync build/ s3://${{ steps.stack-outputs.outputs.bucket }}/ \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "index.html" \
            --exclude "asset-manifest.json"

          aws s3 cp build/index.html s3://${{ steps.stack-outputs.outputs.bucket }}/index.html \
            --cache-control "public,max-age=0,must-revalidate"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.stack-outputs.outputs.distribution }} \
            --paths "/*"
